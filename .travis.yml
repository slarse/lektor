language: python

branches:
  only:
  - master
  - testing
  - tooling

matrix:
  include:
    - python: 3.6
      env:  TRAVIS_NODE_VERSION=10

cache:
  directories:
    - lektor/admin/node_modules

before_install:
  - rm -rf ~/.nvm
  - git clone https://github.com/creationix/nvm.git ~/.nvm
  - (cd ~/.nvm && git checkout `git describe --abbrev=0 --tags`)
  - source ~/.nvm/nvm.sh
  - nvm install $TRAVIS_NODE_VERSION
  - mkdir -p local/bin
  - pushd local/bin
  - wget https://johnvansickle.com/ffmpeg/releases/ffmpeg-release-64bit-static.tar.xz
  - tar -xf ffmpeg-release-64bit-static.tar.xz --strip-components 1 --wildcards "*/ffmpeg" "*/ffprobe"
  - rm ffmpeg-release-64bit-static.tar.xz
  - popd
  - export LEKTOR_RESOURCES=$(pwd)

install:
  - travis_retry pip install --upgrade pytest
  - travis_retry pip install --upgrade codecov
  - travis_retry pip install --editable .[test]
  - travis_retry make build-js

before_script:
  - python --version
  - pip list
  - node --version
  - npm --version
  - $LEKTOR_RESOURCES/local/bin/ffmpeg -version

script: pytest tests

notifications: False
